---
title: "Wpływ wybranych statystyk na poziom szczęścia społeczeństwa"
author: Joanna Kołaczek, Adam Wrzesiński
output: pdf_document
date: "2022-12-18"
---
\renewcommand{\contentsname}{Spis treści}
\renewcommand{\figurename}{Wykres}
\renewcommand{\tablename}{Tabela}

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, fig.pos = "H")
library(kableExtra)
```

```{r echo=FALSE, warning=FALSE, include=FALSE}

library(corrplot)
library(cowplot)
library(dplyr)
library(ggplot2)
library(rnaturalearth)
library(rnaturalearthdata)


df <- read.csv("Data\\WorldHappiness_Corruption_2015_2020.csv")
df$family <- df$family + df$social_support  
df <- subset(df, select = -c(social_support))
apply(df == 0, 2, which)
df[df==0] <- NA
#View(df)
colnames(df) <- c("Państwo", "Szczęście", "PKB na osobę", "Rodzina", "Zdrowie", "Wolność", "Szczodrość", "Zaufanie do rządu","Dystopia", "Kontynent","Rok", "Korupcja")
#View(df)


q <- aggregate(Szczęście ~ Rok + Kontynent, data = df, FUN = mean)
r <- ggplot(q, aes(x=Rok, y=Szczęście, shape= Kontynent)) +
  geom_point() +
  stat_summary(fun = "mean", colour = "red", size = 5, geom = "point",shape = "o") +
  theme(legend.position="top")

q_mean <- aggregate(cbind(Szczęście,`PKB na osobę`,Rodzina, Zdrowie, Wolność, Szczodrość, `Zaufanie do rządu`, Dystopia, Korupcja) ~ Kontynent, data = df, FUN = mean)

#Uśredniony df
df2 <- aggregate(df, list(df$Państwo), mean, na.rm = TRUE)
df2 <- select(df2, -Państwo, -Kontynent,-Rok)
names(df2)[names(df2) == 'Group.1'] <- 'Państwo'
df2 <- merge(df2, select(df, "Państwo", "Kontynent"))
df2 <- df2[!duplicated(df2),]

s <- ggplot(df2, aes(y = Szczęście, x = reorder(Państwo,Szczęście),fill=Kontynent))+
  geom_bar(stat="identity", width=0.5)+
  theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5,size = 3))+
  theme(legend.position="top") + xlab("")

#View(df2)
#corr pętla
corr_df_all <- data.frame()
metody <- c("pearson","spearman")
for(m in metody){
  corr <- cor(df2[,c(3:10)], df2$Szczęście, use = "complete.obs",method = m)
  corr_df <- data.frame(labels(corr),corr)
  colnames(corr_df) <- c("status","corr_method","corr")
  corr_df$corr_method <- m
  corr_df_all <- rbind(corr_df_all,corr_df)
}
t <- ggplot(corr_df_all, aes(x=reorder(status,corr),y=corr,fill=corr_method)) +
  geom_bar(position="dodge",stat="identity", width=0.5)+
  theme(axis.text.x=element_text(angle=45,hjust=1,vjust=1))+
  theme(legend.position="top") + xlab("") + scale_fill_discrete(name = "Metoda korelacji") +ylab("korelacja")


#świat bajer
world <- ne_countries(scale = "medium", returnclass = "sf")
world1 <- left_join(world, df2, by = c("name"="Państwo"))
u <- ggplot(data = world1) +
  geom_sf(aes(fill = Szczęście)) +
  scale_fill_viridis_c(option = "plasma")+
  theme(legend.position="top")

#macierz korelacji z szczesciem w plotrach +hist
p <- list()
h <- list()
index <- 1
for(k in colnames(df2)){
  if(k != "Państwo" & k!= "Kontynent" & k != "Szczęście"){
    p[[index]] <-  ggplot(df2, aes(x = .data[[k]], y = Szczęście))+ 
      geom_point()+
      geom_smooth(method=lm)
    h[[index]] <- ggplot(df2, aes(x = .data[[k]]))+
      geom_histogram(bins = 10)
    index <- index + 1
  }
}
w <- plot_grid(plotlist = p)
v <- plot_grid(plotlist = h)
x <- ggplot(df2, aes(x = Korupcja, y = `Zaufanie do rządu`))+ 
  geom_point()+
  geom_smooth()
#cor(df2$`Zaufanie do rządu`,df2$Korupcja)
```

\newpage

\tableofcontents

\newpage

# Wstęp

Niniejsze sprawozdanie zostało sporządzone w ramach laboratorium Pakietów Statystycznych, prowadzonych przez dr inż. Daniela Kucharczyka[^1], do wykładu dr Andrzeja Giniewicza[^2]. Naszym zadaniem jest analiza wybranych danych rzeczywistych, która posłuży do rozwiązania ustalonego problemu badawczego.
Do wykonania naszego raportu wykorzystamy pakiet R wraz z jego wybranymi bibliotekami, których krótki opis zawarliśmy w Tabeli \ref{tab:pakiety}.

\begin{center}
```{r}

nazwa <- c("corrplot",
           "cowplot",
           "dplyr",
           "ggplot2",
           "rnaturalearth",
           "rnaturalearthdata")
opis <- c("Wizualizacja korelacji między zmiennymi w postaci macierzy korelacji lub wykresu słupkowego.", 
                  "Łatwiejsze komponowanie wielu wykresów na jednym rysunku.",  
                  "Wykonywanie prostych i wydajnych operacji na tabelach danych.",
                  "Tworzenie estetycznych i profesjonalnych wykresów i wizualizacji danych.", 
                  "Pobiera i przetwarza dane o kształcie i granicach krajów oraz innych obszarów geograficznych na całym świecie.",  
                  "Dostarcza dodatkowo wiele innych danych geograficznych.")

Packages <- data.frame(nazwa, opis)
knitr::kable(Packages,"latex", align = c("c", "c"), caption = "Biblioteki używane w raporcie", label = "pakiety") %>%
  kable_styling(latex_options=c("hold_position", "scale_down"))
```
\end{center}
## Przedstawienie danych

Wykorzystamy dane zestawiające estymowany wpływ poszczególnych zmiennych na Poziom Szczęścia społeczeństwa w poszczególnych krajach w latach 2015-2020 zebranych przez instytut Gallupa[^3], wraz z postrzeganym poziomem korupcji CPI (z ang. _corruption perceptions index_) pozyskanymi przez pozarządową organizację Transparency International[^4] w 2015 roku. Konkretny zestaw pobraliśmy z platformy Kaggle, gdzie jeden z użytkowników połączył raporty w jeden zbiór[^5] składający się z następujących zmiennych:

\begin{itemize}
\item \textbf{Poziom szczęścia} - średnia odpowiedzi na pytanie dotyczące oceny życia,
\item \textbf{Państwo} - nazwa państwa do którego odnoszą się pozostałe dane,
\item \textbf{Kontynent} - kontynent na którym znajduje się dane państwo,
\item \textbf{Rok} - rok z którego pochodzą zebrane dane,
\item \textbf{PKB na osobę} - zakres, w jakim PKB na mieszkańca przyczynia się do obliczenia poziomu szczęścia. Jest to stosunek wartości PKB w cenach bieżących do liczby ludności danego obszaru,
\item \textbf{Rodzina} -stopień, w jakim rodzina przyczynia się do obliczenia poziomu szczęścia. Jest to średnia odpowiedzi w danym kraju, na pytanie GWP ,,Czy będąc w potrzebie, możesz zawsze liczyć na krewnych bądź przyjaciół?'',
\item \textbf{Zdrowie} -stopień, w jakim oczekiwana długość życia przyczynia się do obliczenia poziomu szczęścia. Estymowana długość życia, obliczana na podstawie danych Światowej Organizacji Zdrowia,
\item \textbf{Wolność} -stopień, w jakim wolność przyczynia się do obliczenia poziomu szczęścia. Uśredniona odpowiedź na pytanie GWP ,,Czy jesteś usatysfakcjonowany z poziomu wolności wyboru, do tego co chcesz robić w swoim życiu?'',
\item \textbf{Szczodrość} -stopień, w jakim szczodrość przyczynia się do obliczenia poziomu szczęścia. Równa residuum z regresji średniej krajowej odpowiedzi na pytanie ,,Czy w ostatnim miesiącu przekazałeś pieniądze na cele charytatywne?''. Przeliczony w stosunku do PKB na osobę,
\item \textbf{Zaufanie do rządu} - stopień, w jakim zaufanie do rządu przyczynia się do obliczenia poziomu szczęścia. Wnioskowany na podstawie odpowiedzi na pytania ,,Czy korupcja jest rozpowszechniona w rządzie?'' oraz ,,Czy korupcja jest rozpowszechniona w przedsiębiorstwach?''. W przypadku braku danych dotyczących korupcji w rządzie, jako ogólną miarę postrzegania korupcji stosuje się percepcję korupcji w biznesie.
\item \textbf{Korupcja} - Postrzegany poziom korupcji w państwie. Im wyższa punktacja, tym niższa korupcja.
\end{itemize}

```{r, fig.cap="\\label{fig:f1}Poziom szczęścia na świecie", out.width="60%", fig.align = "center"}
v
```

## Cel analizy

Naszym pierwszorzędnym priorytetem będzie znalezienie korelacji między poziomem _korupcji_ a poziomem _szczęścia_. Oczekujemy, że w państwach, gdzie żyje się gorzej, panuje wysoka korupcja. W tym celu zbadamy globalny poziom _szczęścia_ i znajdziemy kraje, w których przyjmuje on skrajne wartości. Następnie przyjrzymy się jak poszczególne statystyki wpływają na _szczęście_ dla tych państw. Dodatkowo sprawdzimy, jak zmieniał się estymowany wpływ korupcji na _szczęście_ w czasie.
Na podstawie tych informacji wyciągniemy wnioski.

[^1]:: \href{http://prac.im.pwr.edu.pl/~giniew/doku.php}{http://prac.im.pwr.edu.pl/~giniew/doku.php}
[^2]:: \href{http://prac.im.pwr.edu.pl/~kucharczyk/}{https://dkucharc.github.io/academic/}
[^3]:: \href{https://worldhappiness.report/archive/}{https://worldhappiness.report/archive/}
[^4]:: \href{https://www.transparency.org/en/cpi/2021}{https://www.transparency.org/en/cpi/2021}
[^5]:: \href{https://www.kaggle.com/datasets/eliasturk/world-happiness-based-on-cpi-20152020}{https://www.kaggle.com/datasets/eliasturk/world-happiness-based-on-cpi-20152020}

\newpage

# Analiza i wizualizacja danych

Najpierw zobaczmy jak wyglądają dane. Wnioskujemy z opisu danych (zrobić odniesienie), że kolumny _Rodzina_ i _Wsparcie społeczne_ mówą o tym samym i uzupełniają się wzajemnie. W związku z tym wartości z _wsparcia_ dopisujemy do _rodziny_ i usuwamy niepotrzebną kolumnę. Braki danych w zestawie są opisane jako zera. Do znalezienia ich użyjemy funkcji _which_ użytej do każdej kolumny naszego zbioru. Zwróci ona pozycję zer. Gdzieniegdzie te braki danych mogą nieść pewną dodatkową informację. Przykładowo, jeśli napotkamy zera w kolumnie *Wolność* może oznaczać brak możliwości umieszczenia konkretnego pytania w ankiecie z powodów politycznych. Zamieniamy te wartości na *NA*, by nie przeszkadzały w liczeniu średnich wartości w dalszej części sprawozdania. Kilka pierwszych rzędów przekształconego w ten sposób zestawu umieszczamy w tabeli \ref{tab:head}. Zauważmy, że estymowane statystyki sumują się do *Szczęścia*. Po użyciu funkcji *unique* dla kolumn Państw i kontynentów dowiadujemy się, że mamy do dyspozycji dane pochodzące ze 132 państw, rozmieszczonych na wszystkich kontynentach zebrane w latach 2015-2020. Zobaczmy jak na przestrzeni czasu wyglądało *Szczęście* dla każdego z kontynentów \ref{fig:trend}. Kolorem czerwonym została oznaczona średnia z całego świata.

```{r, fig.cap="\\label{fig:trend}Średnie szczęście na przestrzeni lat", out.width="60%", fig.align = "center"}
r
```




Widzimy, że dane nieznacznie fluktuują zatem uśrednimy je w celu bardziej przejrzystej analizy. Średni _poziom szczęścia_ każdego państwa umieszczamy na wykresie \ref{fig:szczęście}, oznaczając kolorem kontynent w którym się ono znajduje.
Zauważamy, że w niższej strefie dominują kraje z Afryki i Azji, natomiast w wyższej - Australii i Ameryki Północnej. Nanieśmy więc średni _poziom szczęścia_ na mapę świata (rys. \ref{fig:świat}). Nasze przypuszczenia się potwierdzają. Jest stosunkowo dużo braków danych w Afryce. Biorąc pod uwagę jednak to, że dosyć podobnie rozłożony jest tam średni _poziom szczęścia_, nie traktujemy tego jako problem. Na uwagę zasługuje Afganistan, który stanowi pewnego rodzaju ciemną wyspę na tle Azji. Podobnie Ukraina na tle Europy.


```{r, echo=FALSE, warning=FALSE}
knitr::kable(df[1:6,], "latex", caption = "Pierwsze rzędy zestawu danych", label = "head") %>% 
  kable_styling(latex_options = "scale_down")
```

```{r, echo=FALSE, warning=FALSE}
knitr::kable(q_mean, "latex", caption = "Średnie wartości statystyk na kontynentach", label = "meany") %>% 
  kable_styling(latex_options = "scale_down")
```

```{r, fig.cap="\\label{fig:szczęście}Poziom szczęścia dla danych krajów", out.width="100%", fig.align = "center"}
s
```


```{r, fig.cap="\\label{fig:świat}Poziom szczęścia na świecie", out.width="60%", fig.align = "center"}
u
```


Przejdźmy teraz do analizy korelacji między poziomem _szczęścia_ a wybranymi czynnikami. Przypomnijmy po krótce na czym będą polegały użyte w raporcie metody.
\begin{itemize}
\item {Korelacja Pearsona} mierzy stopień zależności liniowej pomiędzy dwoma zmiennymi.
\item {Korelacja Spearmana} mierzy stopień korelacji pomiędzy dwoma zmiennymi na podstawie ich pozycji w rankingu. Może być obliczana dla danych, które nie są dobrze opisane przez prostą, ale istnieje między nimi jakiś rodzaj zależności.
\end{itemize}
Obie wymienione wyżej korelacje przyjmują wartości z przedziału od -1 do 1. Im bliżej zera, tym mniej skorelowane są dane, natomiast im bliżej wartości brzegowych, tym korelacja jest silniejsza (odpowiednio ujemna i dodatnia). 


```{r, fig.cap="\\label{fig:korelacje}Korelacja poziomem szczęścia a wybranymi statystykami", , out.width="60%", fig.align = "center"}
t
```

Wykres \ref{fig:korelacje} przedstawia wielkość korelacji Pearsona i Spearmana między poziomem _szczęścia_ a czynnikami z naszego zbioru danych. Oba dają podobne wyniki, zatem możemy się spodziewać zależności liniowej. Aby lepiej przyjrzeć się występującym zależnościom, przedstawimy badane dane na wykresach punktowych.

```{r, fig.cap="\\label{fig:scatters}Poziom szczęścia na świecie", out.width="60%", fig.align = "center"}
w
```
Na wykresach \ref{fig:scatters} traktujemy poszczególne czynniki jako zmienne opisujące, natomiast _szczęście_ jako zmienną opisywaną. Dodatkowo prosta jest wynikiem zastosowania regresji liniowej. Patrząc na otrzymane wykresy oraz korelacje widzimy, że największą zależność ze _szczęściem_ mają _rodzina_, _zdrowie_ i _PKB na osobę_, czyli powszechnie uznawane wartości. Jeżeli te czynniki będą utrzymane na wysokim poziomie, spodziewamy się że szczęście również takie będzie. Najgorzej w zestawieniu wypada _szczodrość_ - nie możemy wnioskować czy jeżeli ta będzie rosnąć, rosnąć bedzie również nasza zmienna opisywana, regresja liniowa w tym przypadku nie jest uzasadniona. Uwagę może zwrócić również fakt, że korelacja _szczęścia_ z _korupcją_ jest istotnie wyższa niż korelacja _szczęścia_ z _zaufaniem do rządu_, gdzie oba czynniki mierzą poziom korupcji, przy czym to drugie bada jej wpływ na _szczęście_. Pokazuje nam to, że nie zawsze korelacja oznacza przyczynowość.

```{r, fig.cap="\\label{fig:zaufanie do rządu a korupcja}Zestawienie statystyk dotyczących korupcji", out.width="60%", fig.align = "center",warning=FALSE}
x
```
Aby zobaczyć dokładniej jak ma się _korupcja_ do _zaufania do rządu_, przyjrzymy się wykresowi \ref{fig:zaufanie do rządu a korupcja}. Widzimy, że gdy korupcja jest wysoka (tzn. przyjmuje niskie wartości na osi), jej wpływ na szczęście jest nikły, ale nie występuje tu oczywista zależność, natomiast gdy zaczyna ona spadać (dla wartości większych od 50), jej wpływ na szczęście staje się bardziej istotny. W tym przypadku możemy próbować doszukiwać się zależności innej niż liniowa, chociażby oznaczonej.

# Podsumowanie